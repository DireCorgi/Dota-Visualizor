(function(q,p){var s={ACTION_TYPE:{PRIMARY:0,SECONDARY:1},SELECTOR:{CONNECTION_LIST:".connection-tab-people-list",ACTIONS_WRAPPER:".connection-item-actions-wrapper",INVITATIONS_WRAPPER:"#addconnections .connection-tab-people-list",HEADLINE:".item-secondary-headline",CONNECTION_TYPE:"data-connection-type",BUTTON_TRK_CODE:"data-li-trk-code",IGNORE_CONFIRMATION:".ignore-confirmation",CLOSE_CONFIRMATION:".close-confirmation",INVITE_SPAM:'[data-action\x3d"invitationReportAbuse"]',INVITE_DECLINE:'[data-action\x3d"invitationDecline"]',
LIST_ITEM_CONTAINER:"li",DUMMY_EMAIL:"data-li-dummy-email",IMPORTER_FORM:"#abook",INPUT_SUBMIT:'input[type\x3d"submit"]',INPUT_EMAIL:'input[name\x3d"email"]',INPUT_ORIGIN:'input[name\x3d"origin_name"]',OTHER_EMAIL_ID:"other-email-li",SCROLL_CONTENT:".li-scroll-content"},CSS_CLASS:{LIST_ITEM_ACTION:"connection-item-action",IN_PROGRESS:"in-progress",ACTION_DONE:"success-card",SHOW_MESSAGING:"show-msg",MESSAGE_BUTTON:"message-button",FADE:"fade",FOCUS:"focus",ERROR:"error",IGNORED:"ignored",ABOOK_CONTAINER:"connection-importer-container",
LIST_ITEM_SELECTED:"selected",DUMMY_USED:"using-dummy",ENABLE_BACKFILL:"enable-backfill"},CONNECTION_TYPE:{PYMK:"pymk",INVITATIONS:"invitation",GYMK:"gymk"},CONNECTION_BEHAVIORS:{RIVER:"river",REDIRECT:"redirect"},OFFSET_SIZE:10},b={},h=null,f=null,r=["scripts/apps/chrome/remote-nav/consumer2/katy/modules/DragonBars"];q.AddConnectionsManager=p.resolve("Promise, Delegate, Request, Helpers, CustomEvents, AddConnectionsFactory, AddConnectionsDecorator, WebTracking",function(a,b,e,k,g,d,f,h,l){this.promise=
new a;this.delegate=b;this.config=s;this.el=l;this.factory=d;this.decorator=f;this.helpers=k;this.request=e;this.webTracking=h;this.response={};this.events=g;this.ignoredInvitationsQueue=[];this.ignoredPymkQueue=[];this.importerContainer=this.fnButtonType=null;this._init()});p.register("AddConnectionsManager",q.AddConnectionsManager);var d=q.AddConnectionsManager.prototype;d._init=function(){if(!this.el)throw Error("No element defined in the add connections config");var a=this._getCountDataFromEl(this.el),
c=this.factory,e=this.decorator,k=new this.request,g=LIModules.imports("Events");c.switchOn();b=this.config=this.helpers.extendObject(this.config,this.factory.getConfig(),a);c.setTotalPymk(a.TOTAL_PYMK_RETURNED);c.setTotalInvitations(a.TOTAL_INVITATIONS_RETURNED);c.setRandomSeed(a.RANDOM_SEED);g||r.push("scripts/apps/chrome/consumer2/core/Events");k.getScript(this.helpers.getJSpath(r)).done(function(){p.dependencies.DragonBars&&(this._dragonbars=new p.dependencies.DragonBars(this.el.querySelector(b.SELECTOR.SCROLL_CONTENT),
{}));this.loadFetchFormDeps()}.bind(this));this._attachEvents();a.TOTAL_INVITATIONS_RETURNED>b.MAX.INVITATIONS&&this._enableOverflow(document.querySelector(b.SELECTOR.INVITATIONS_WRAPPER));this._markInvitationsAsSeen().done(function(){e.updateNavBadge(c.getNotificationStyle(),!1)},function(a){throw Error("Failed to mark invitations as seen");});return this._init};d._getCountDataFromEl=function(a){var b=a.querySelector("[data-total-invitations]");a=a.querySelector("[data-total-pymk]");var e={};e.TOTAL_PYMK_RETURNED=
a?a.getAttribute("data-total-pymk")||0:0;e.TOTAL_INVITATIONS_RETURNED=b?b.getAttribute("data-total-invitations")||0:0;e.RANDOM_SEED=a?a.getAttribute("data-random-seed"):"";return e};d._attachEvents=function(){this.delegate(this.el,"."+b.CSS_CLASS.LIST_ITEM_ACTION+":not(."+b.CSS_CLASS.MESSAGE_BUTTON+")","click",this._onButtonClick,this);this.delegate(this.el,b.SELECTOR.CLOSE_CONFIRMATION,"click",this._closeDialog,this);this.delegate(this.el,b.SELECTOR.INVITE_SPAM,"click",this._handleSpamInvites,this);
this.delegate(this.el,b.SELECTOR.INVITE_DECLINE,"click",this._handleSpamInvites,this);this.delegate(this.el,"."+b.CSS_CLASS.LIST_ITEM_ACTION,"focus blur",this._toggleWrapperFocus,this)};d._onButtonClick=function(a){a.preventDefault();var c=this,e=this.decorator,k=e.getButtonEl(a),g=e.getClosest("form"),d=e.getClosest(b.SELECTOR.ACTIONS_WRAPPER),m=k.getAttribute(b.SELECTOR.BUTTON_TRK_CODE)||null,n=this.factory.getLix();h=e.ACTIVE_LIST_ITEM;f=d.getAttribute(b.SELECTOR.CONNECTION_TYPE);this.fnButtonType=
f===b.CONNECTION_TYPE.GYMK?b.CONNECTION_TYPE.PYMK:f===b.CONNECTION_TYPE.INVITATIONS?f+"s":f;this.fnButtonType=this.fnButtonType.charAt(0).toUpperCase()+this.fnButtonType.slice(1);if(!k||!g)throw Error("No form or button found for the action",a);m&&this.webTracking.trackUserAction(m);if((n.get("global_nav_invitations_connect_behavior")===b.CONNECTION_BEHAVIORS.REDIRECT&&f===b.CONNECTION_TYPE.INVITATIONS||n.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.REDIRECT&&f===b.CONNECTION_TYPE.PYMK||
n.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.REDIRECT&&f===b.CONNECTION_TYPE.GYMK)&&e.getButtonActionType()===b.ACTION_TYPE.PRIMARY)return g.submit();e.addActiveLoader(b.CSS_CLASS.IN_PROGRESS);return this._makeRequest(g).done(function(a){c._handleSuccessResponse(a)},function(){g.submit()})};d._makeRequest=function(a){var b=a.getAttribute("action");return this._ajaxRequest(b,{type:a.getAttribute("method"),data:this.decorator.serializeForm(a),headers:{"X-IsAJAXForm":1,"X-Requested-With":"XMLHttpRequest",
"Content-Type":"application/x-www-form-urlencoded; charset\x3dUTF-8"}})};d._ajaxRequest=function(a,b){return(new this.request).ajax(a,b)};d._handleSuccessResponse=function(a){var b=this.decorator,e=this.helpers;a=JSON.parse(a);e.isObject(a)||(a={status:"fail",response:e.encode(a)});this.events.on("actionDone",function(){b.removeActiveLoader()});a=this.response=a;return"ok"===(a.status||"fail")?this._handleItem(a):this._handleErrorItem()};d._handleItem=function(a){var c=this.decorator.getButtonActionType(),
e=this.factory.getLix();c===b.ACTION_TYPE.PRIMARY?(h.classList.add(b.CSS_CLASS.ACTION_DONE),(a=f===b.CONNECTION_TYPE.INVITATIONS&&e.get("global_nav_invitations_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER||f===b.CONNECTION_TYPE.PYMK&&e.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER||f===b.CONNECTION_TYPE.GYMK&&e.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER?!0:!1)?h.classList.add(b.CSS_CLASS.FADE):h.classList.add(b.CSS_CLASS.SHOW_MESSAGING),this._updateHeadline()):
this._handleIgnore(a);this._onActionDone()};d._handleIgnore=function(a){var c;h.classList.add(b.CSS_CLASS.FADE);"content"in a&&(c=document.createElement("div"),c.innerHTML=a.content,a=c.querySelector(b.SELECTOR.IGNORE_CONFIRMATION),h.appendChild(a),h.classList.add(b.CSS_CLASS.IGNORED),this["ignored"+this.fnButtonType+"Queue"].push(h));return this.updateCounts()};d._handleErrorItem=function(){var a=this.decorator,c=h.querySelector(b.SELECTOR.HEADLINE),e=this.factory.getI18n().get("global_nav_connection_tab_error_state")||
"";h.classList.add(b.CSS_CLASS.ACTION_DONE,b.CSS_CLASS.ERROR);this.events.trigger("actionDone");return a.updateElText(c,e)};d._updateHeadline=function(){var a=h.querySelector(b.SELECTOR.HEADLINE),c;c=this.factory.getI18n().get("global_nav_"+this.fnButtonType.toLowerCase()+"_confirmation")||"";return this.decorator.updateElText(a,c)};d._onActionDone=function(){var a=this._getFetchReqs(),c=a.verdict,e=this,k=this.factory.getLix(),k=k.get("global_nav_invitations_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER&&
f===b.CONNECTION_TYPE.INVITATIONS||k.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER&&f===b.CONNECTION_TYPE.PYMK||k.get("global_nav_pymk_connect_behavior")===b.CONNECTION_BEHAVIORS.RIVER&&f===b.CONNECTION_TYPE.GYMK||h.classList.contains(b.CSS_CLASS.IGNORED);c&&k?this._fetchBackfill(a).done(function(a){a.length?e._handleFetchedData(a):e._resetParentHeight();e.events.trigger(f+"BackFillDone")},function(a){throw Error("Backfill request failed",a.responseText);}):this._setFadeAction();
this.events.trigger("actionDone")};d._handleFetchedData=function(a){var c=this.factory,e=this.fnButtonType,k=this.decorator.getClosest(b.SELECTOR.CONNECTION_LIST),g=document.createElement("section"),d=0,f=c["getTotal"+e](),d={};a&&(g.innerHTML=a,d=this._getCountDataFromEl(g),d=parseInt(d["TOTAL_"+e.toUpperCase()+"_RETURNED"],10),a=g.querySelector(b.SELECTOR.CONNECTION_LIST),c.setCount(e,d+f),this._enableOverflow(),k.insertAdjacentHTML("beforeend",a.innerHTML));this._setFadeAction()};d._enableOverflow=
function(a){(a=a||this.decorator.getClosest(b.SELECTOR.CONNECTION_LIST))&&!a.classList.contains(b.CSS_CLASS.ENABLE_BACKFILL)&&(a.style.height=a.clientHeight+"px",a.classList.add(b.CSS_CLASS.ENABLE_BACKFILL));return a};d._setFadeAction=function(){var a=this.decorator,c=h,e=c.classList.contains(b.CSS_CLASS.IGNORED),d=this["ignored"+this.fnButtonType+"Queue"],g;if(!c.classList.contains(b.CSS_CLASS.FADE)||e&&1===d.length)return!1;2>d.length&&(a.fadeElOut(c,this.events,f),g=this.updateCounts());d.length&&
(a.fadeElOut(d[0],this.events,f),d.splice(0,1));return g};d.updateCounts=function(){var a=this.factory,c=this.decorator,e=c.updateHeaderCounts(this.el.querySelector("."+f+"-count"));f===b.CONNECTION_TYPE.INVITATIONS&&c.updateNavBadge(a.getNotificationStyle());return e};d._markInvitationsAsSeen=function(){this.factory.newInvitations=0;if(!b.MARK_AS_SEEN_URL)throw Error("No mark seen URL specified");return this._ajaxRequest(b.MARK_AS_SEEN_URL,{data:{type:"invitation",rnd:(new Date).getTime()},headers:{"X-IsAJAXForm":1,
"X-Requested-With":"XMLHttpRequest"}})};d._getFetchReqs=function(){var a=this.fnButtonType,c=this.factory,e=!1,d={},g="getTotal"+a,h="setTotal"+a,m="getMax"+a,n=c["needs"+a+"Results"],l=c["getOffset"+a]()||0,g=parseInt(c[g](),10),m=c[m]();0===g&&(g=parseInt(b["total"+a+"Returned"],10));g<=m&&n?(e=!0,l=0===l||5===l&&f===b.CONNECTION_TYPE.INVITATIONS?l+(f===b.CONNECTION_TYPE.INVITATIONS?0:1):l+b.OFFSET_SIZE,d.offset=l,c.setOffset(a,l)):0===l&&g>m&&c.setOffset(a,g);d.verdict=e;c.setFetchData(d);g--;
c[h](g);return d};d._resetParentHeight=function(){var a=this.decorator.getListContainer(b.SELECTOR.CONNECTION_LIST),c=this.fnButtonType,e=a.style.height;this.factory["needs"+c+"Results"]&&this.factory.setResultsBool(c,!1);"auto"!==e&&a.classList.remove(b.CSS_CLASS.ENABLE_BACKFILL);0===this._setFadeAction()&&(this.events.trigger("destroy"+this.fnButtonType+"Container"),a.parentNode.removeChild(a))};d._fetchBackfill=function(a){var b=this.fnButtonType;a=this.factory["get"+b+"Url"]();b=this["_create"+
b+"DataObj"]()||{};return this._ajaxRequest(a,{data:b,type:"GET"})};d._createInvitationsDataObj=function(){return{offset:this.factory.getOffsetInvitations(),count:this.config.OFFSET_SIZE,fetchMode:"noncached"}};d._createPymkDataObj=function(){return{offset:this.factory.getOffsetPymk(),count:this.config.OFFSET_SIZE,fetchMode:"noncached",seed:this.config.RANDOM_SEED}};d._toggleWrapperFocus=function(a){var c="focus"===a.type;(a=this.decorator.getClosest(b.SELECTOR.LIST_ITEM_CONTAINER,a.target))&&a.classList.toggle(b.CSS_CLASS.FOCUS,
c)};d._closeDialog=function(a){a.preventDefault();a=this.decorator.getClosest(b.SELECTOR.LIST_ITEM_CONTAINER,a.target);a.classList.add(b.CSS_CLASS.FADE);this.decorator.fadeElOut(a,this.events,f)};d._handleSpamInvites=function(a){a.preventDefault();a=a.target;var c=a.getAttribute("data-action-url"),e=this.decorator.getClosest(b.SELECTOR.IGNORE_CONFIRMATION,a);c&&(e.classList.add(b.CSS_CLASS.IN_PROGRESS),this._ajaxRequest(c,{headers:{"X-IsAJAXForm":1,"X-Requested-With":"XMLHttpRequest"}}).done(function(a){e.classList.remove(b.CSS_CLASS.IN_PROGRESS);
a=JSON.parse(a);e.innerHTML=a.content},function(a){e.classList.remove(b.CSS_CLASS.IN_PROGRESS);throw Error("Error requesting spam request");}))};d.loadFetchFormDeps=function(){for(var a=this.el.querySelector("."+b.CSS_CLASS.ABOOK_CONTAINER),c=a.querySelectorAll("script")||[],e=this,d=new this.request,g,f=0,h=c.length;f<h&&!(g=c[f].getAttribute("src"));f++);if(0===g.length)return!1;e.importerContainer=a;d.getScript(g).done(function(){e.delegate(a,"a","click",e._handleEmailProviderClick,e)},function(){throw Error("Fetch form dependencies failed to load");
})};d._handleEmailProviderClick=function(a){a.preventDefault();var c=this.importerContainer.querySelector(b.SELECTOR.IMPORTER_FORM),e=c.querySelector(b.SELECTOR.INPUT_EMAIL)||null,d=c.querySelector(b.SELECTOR.INPUT_ORIGIN)||null;a=a.target;var g=this,f,h;"a"===a.nodeName.toLowerCase()&&(f=a.parentNode,h=(a=f.getAttribute(b.SELECTOR.DUMMY_EMAIL))?a.substring(a.indexOf("@")+1,a.lastIndexOf(".")):"other",window.addEventListener("addConnectionsImporterError",function(a){g._selectOtherEmail({container:f,
form:c,errorType:a.detail.err})}),window.addEventListener("addConnectionsResolverComplete",function(){window.setTimeout(function(){g._redrawFormScroller(c)},0)}),e&&d&&"other"!==h?((document.getElementById(b.SELECTOR.OTHER_EMAIL_ID)||f).classList.remove(b.CSS_CLASS.LIST_ITEM_SELECTED),c.classList.remove(b.CSS_CLASS.LIST_ITEM_SELECTED),e.value=a,e.classList.add(b.CSS_CLASS.DUMMY_USED),d.value=h,window.dispatchEvent(new window.CustomEvent("addConnectionsSubmit",{detail:{origin:h}}))):g._selectOtherEmail({container:f,
form:c}))};d._selectOtherEmail=function(a){if(!(a instanceof Object&&0===Object.keys(a).length)){var c=a.form,e=a.container;c.querySelector(b.SELECTOR.INPUT_SUBMIT);var d=c.querySelector(b.SELECTOR.INPUT_EMAIL);a=a.errorType||"";var f=d.classList.contains(b.CSS_CLASS.DUMMY_USED);a=f||!f&&"importerBadLogin"!==a;e.classList.add(b.CSS_CLASS.LIST_ITEM_SELECTED);c.classList.add(b.CSS_CLASS.LIST_ITEM_SELECTED);a&&(d.classList.remove(b.CSS_CLASS.DUMMY_USED),d.value="");this._redrawFormScroller(c)}};d._redrawFormScroller=
function(a){var b=this._dragonbars;a.scrollIntoView(!1);b&&b.redraw()}})(window.globalNav,window.globalNav.__internal__.Injector);